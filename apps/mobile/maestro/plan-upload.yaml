# Plan Upload Flow
# Uploads a PDF plan from device storage
# Can start from the Projects list or from inside a project
#
# Prerequisites:
#   - User must be logged in (run auth-login.yaml first)
#   - A project must exist (run project-create.yaml first)
#   - Backend running (bun dev:network)
#   - adb reverse ports set up (tcp:8081 and tcp:8787)

appId: com.nessei.sitelink
---
# Launch app without clearing state (preserves login session)
- launchApp

# Handle dev client launcher if it appears
- extendedWaitUntil:
    visible: 'DEVELOPMENT SERVERS'
    timeout: 5000
    optional: true
- runFlow:
    when:
      visible: 'DEVELOPMENT SERVERS'
    commands:
      - tapOn: 'http://localhost:8081'

# Dismiss dev menu intro popup if it appears
- runFlow:
    when:
      visible: 'Continue'
    commands:
      - tapOn: 'Continue'
      - pressKey: back

# Wait for the app to fully load (Projects screen or inside a project)
- extendedWaitUntil:
    visible: 'Riverside Apartments'
    timeout: 30000

# Tap into the project
- tapOn: 'Riverside Apartments'
- waitForAnimationToEnd

# Verify we're on the Plans tab inside the project
- extendedWaitUntil:
    visible: 'Plans'
    timeout: 10000

# Tap FAB (+ button) to open upload sheet
- tapOn:
    point: '90%,90%'

# Wait for upload sheet
- extendedWaitUntil:
    visible: 'Upload Plan'
    timeout: 5000
- assertVisible: 'Device Storage'

# Select device storage option
- tapOn: 'Device Storage'
- waitForAnimationToEnd

# Android file picker opens to Recent view
- extendedWaitUntil:
    visible: 'Recent'
    timeout: 5000

# Find the structural drawings PDF in recent files
- scrollUntilVisible:
    element:
      text: '4-Structural.*'
    direction: DOWN
    timeout: 10000

# Select the PDF
- tapOn:
    text: '4-Structural.*'
- waitForAnimationToEnd

# Some file pickers require tapping Select/Open
- runFlow:
    when:
      visible: 'Select'
    commands:
      - tapOn: 'Select'
- runFlow:
    when:
      visible: 'Open'
    commands:
      - tapOn: 'Open'

# Wait for upload to start - modal shows "Uploading Plan"
- extendedWaitUntil:
    visible: 'Uploading Plan'
    timeout: 10000
    optional: true

# Wait for upload to complete and sheets to appear
# This can take 30-60 seconds for processing
- extendedWaitUntil:
    notVisible: 'Uploading Plan'
    timeout: 60000
    optional: true

# After processing completes, we should see sheets
# Wait for at least one sheet to appear (sheet numbers like S2, S4, O8, etc.)
- extendedWaitUntil:
    visible:
      text: '.*plans.*'
    timeout: 120000

# Take a screenshot of the result
- takeScreenshot: plan-upload-result
