# Demo Mode Setup

Demo mode (`EXPO_PUBLIC_DEMO_MODE=true`) uses real plan images and real YOLO+Gemini pipeline-detected markers from `apps/4-Structural-Drawings - 4pages.pdf`. This is set up in `apps/mobile/lib/demo-mode.ts`.

## Bundled Assets

| Asset | Description |
|---|---|
| `assets/demo/sheet-s{1-4}.png` | 4 plan images rendered at 72 DPI (3456×2592) |
| `lib/demo-mode.ts` | 122 pipeline-detected markers across 4 sheets + fabricated schedule/notes/legend/region data |
| `lib/image-utils.ts` | Maps `DEMO_PLACEHOLDER_S{1-4}` URLs to bundled PNG assets |

## Sheet Mapping

| Demo Sheet | PDF Page | Sheet Number | Description | Markers |
|---|---|---|---|---|
| S1 (`demo-sheet-s1`) | Page 1 | S0.0 | Cover & Schedules | 1 |
| S2 (`demo-sheet-s2`) | Page 2 | S1.0 | Foundation Plan | 91 |
| S3 (`demo-sheet-s3`) | Page 3 | S2.0 | Foundation Details | 4 |
| S4 (`demo-sheet-s4`) | Page 4 | S3.0 | Second Floor Framing | 26 |

## How Markers Were Generated

1. Rendered each PDF page at **72 DPI** using PyMuPDF (critical: YOLO model was trained at 72 DPI)
2. Sent each rendered PNG to the container endpoint `POST http://localhost:3001/detect-callouts` with headers:
   - `X-Sheet-Id`, `X-Plan-Id`, `X-Sheet-Number`, `X-Valid-Sheet-Numbers`
3. Container runs YOLO v8n (4-class: `detail`, `elevation`, `title`, `grid_bubble`) + SAHI tiling (2048px, 20% overlap)
4. Gemini Flash (via OpenRouter) extracts text labels from each detected crop
5. Pipeline returns normalized 0–1 coordinates, labels, cross-sheet references, confidence scores
6. Output was captured and hardcoded into `demo-mode.ts`

## Fabricated Data (Not From Pipeline)

The following data is manually fabricated (not generated by the pipeline):

- **Schedule entries**: footing schedule (6 entries) + pier schedule (4 entries) on sheet S1
- **Notes extractions**: on S1, S2, S4
- **Legend crops**: on S1, S2
- **Layout regions**: 7 regions across sheets (schedule, notes, legend, detail types)

## How to Regenerate Demo Data

### Prerequisites

```bash
# Start the PDF processor container
cd apps/backend/container
docker build -t pdf-processor .
docker run -d -p 3001:8080 \
  -e "OPENROUTER_API_KEY=<key from apps/backend/.dev.vars>" \
  --name container-pdf-processor \
  pdf-processor
```

### Step 1: Render PDF pages at 72 DPI

```python
import fitz  # PyMuPDF: pip install pymupdf

doc = fitz.open("apps/4-Structural-Drawings - 4pages.pdf")
for i, page in enumerate(doc):
    pix = page.get_pixmap(dpi=72)
    pix.save(f"apps/mobile/assets/demo/sheet-s{i+1}.png")
```

### Step 2: Send each page through the detection pipeline

```bash
# Example for sheet S2 (Foundation Plan — most markers)
curl -X POST http://localhost:3001/detect-callouts \
  -H "Content-Type: image/png" \
  -H "X-Sheet-Id: demo-sheet-s2" \
  -H "X-Plan-Id: demo-plan-001" \
  -H "X-Sheet-Number: S1.0" \
  -H "X-Valid-Sheet-Numbers: S0.0,S1.0,S2.0,S3.0" \
  --data-binary @apps/mobile/assets/demo/sheet-s2.png \
  > page2_callouts.json
```

Repeat for sheets S1, S3, S4 with appropriate headers.

### Step 3: Update demo-mode.ts

Convert the JSON output from each sheet into the TypeScript marker arrays in `apps/mobile/lib/demo-mode.ts`.

## Resetting Demo Data

To re-seed demo data after code changes:

**Option A: In-app (iOS Simulator)**
- App Settings → Developer Tools → "Clear Database & Restart"

**Option B: Android (ADB)**
```bash
adb shell "run-as com.nessei.sitelink rm -rf /data/data/com.nessei.sitelink/files/SQLite/demo-store"
# Then restart the app
```

## Future: Automation Script

No automation script exists yet. If demo data needs frequent regeneration, consider creating `scripts/regenerate-demo-data.py` that:
1. Renders PDF pages at 72 DPI
2. Hits pipeline endpoints for each sheet
3. Generates the TypeScript arrays in `demo-mode.ts` programmatically
